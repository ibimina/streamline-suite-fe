name: ğŸ”„ Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

concurrency:
  group: dependency-updates
  cancel-in-progress: true

jobs:
  # Update npm dependencies
  update-dependencies:
    name: ğŸ“¦ Update Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ” Check for updates
        id: updates
        run: |
          npm outdated --json > outdated.json || true

          if [ -s outdated.json ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Found dependency updates"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "âœ… All dependencies up to date"
          fi

      - name: ğŸ“¦ Update dependencies
        if: steps.updates.outputs.has_updates == 'true'
        run: |
          # Update patch and minor versions only
          npx npm-check-updates -u --target minor
          npm install

      - name: ğŸ§ª Run tests
        if: steps.updates.outputs.has_updates == 'true'
        run: |
          npm run lint
          npm run type-check
          npm run test:ci
          npm run build

      - name: ğŸ“ Create update summary
        if: steps.updates.outputs.has_updates == 'true'
        id: summary
        run: |
          echo "## ğŸ“¦ Dependency Updates" > update_summary.md
          echo "" >> update_summary.md
          echo "The following dependencies have been updated:" >> update_summary.md
          echo "" >> update_summary.md

          # Compare package.json changes
          git diff package.json | grep "^+" | grep -v "^+++" | sed 's/^+/- /' >> update_summary.md

          echo "" >> update_summary.md
          echo "### âœ… Tests Passed" >> update_summary.md
          echo "- Linting: âœ…" >> update_summary.md
          echo "- Type checking: âœ…" >> update_summary.md
          echo "- Unit tests: âœ…" >> update_summary.md
          echo "- Build: âœ…" >> update_summary.md

      - name: ğŸ”€ Create Pull Request
        if: steps.updates.outputs.has_updates == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'ğŸ“¦ Automated Dependency Updates'
          body-path: update_summary.md
          branch: automated/dependency-updates
          labels: |
            dependencies
            automated
          reviewers: |
            # Add your team members here
          assignees: |
            # Add assignees here

  # Security audit
  security-audit:
    name: ğŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ›¡ï¸ Run security audit
        id: audit
        run: |
          # Run audit and capture output
          npm audit --audit-level=moderate --json > audit-results.json || true

          # Check if there are vulnerabilities
          VULN_COUNT=$(cat audit-results.json | jq -r '.metadata.vulnerabilities.total // 0')

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
            echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT
            
            # Create human-readable report
            echo "# ğŸ›¡ï¸ Security Audit Report" > security-report.md
            echo "" >> security-report.md
            echo "Found **$VULN_COUNT** security vulnerabilities that need attention." >> security-report.md
            echo "" >> security-report.md
            
            # Add vulnerability details
            npm audit --audit-level=moderate >> security-report.md || true
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
            echo "âœ… No security vulnerabilities found"
          fi

      - name: ğŸš¨ Create security issue
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the security report
            const reportContent = fs.readFileSync('security-report.md', 'utf8');

            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,vulnerability',
              state: 'open'
            });

            const existingIssue = issues.find(issue => 
              issue.title.includes('Security Vulnerabilities Detected')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## ğŸ”„ Updated Security Report\n\n${reportContent}\n\n---\n*Updated: ${new Date().toISOString()}*`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ›¡ï¸ Security Vulnerabilities Detected - Action Required',
                body: reportContent,
                labels: ['security', 'vulnerability', 'high-priority']
              });
            }

      - name: ğŸ“¢ Notify team about vulnerabilities
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: 'warning'
          channel: '#security'
          username: 'Security Bot'
          icon_emoji: ':warning:'
          text: |
            ğŸ›¡ï¸ Security Alert: ${{ steps.audit.outputs.vulnerability_count }} vulnerabilities detected in Streamline Suite dependencies.

            Please review the security issue created in GitHub and take appropriate action.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SECURITY_SLACK_WEBHOOK_URL }}
